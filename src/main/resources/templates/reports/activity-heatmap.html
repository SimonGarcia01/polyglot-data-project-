<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"></head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container">
        <div class="report-header">
            <h1>üî• Activity Heatmap</h1>
            <p>Tu calendario de actividad de los √∫ltimos 365 d√≠as</p>
            <a th:href="@{/reports}" class="btn btn-secondary">‚Üê Volver a Informes</a>
        </div>

        <div class="heatmap-container">
            <h3>Calendario de Entrenamientos</h3>
            <p class="heatmap-description">
                Cada celda representa un d√≠a. Los colores m√°s intensos indican m√°s sesiones de entrenamiento ese d√≠a.
            </p>

            <div id="heatmap"></div>

            <div class="heatmap-legend">
                <span>Menos</span>
                <div class="legend-box" data-level="0"></div>
                <div class="legend-box" data-level="1"></div>
                <div class="legend-box" data-level="2"></div>
                <div class="legend-box" data-level="3"></div>
                <div class="legend-box" data-level="4"></div>
                <span>M√°s</span>
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-value" id="total-days">0</div>
                <div class="stat-label">D√≠as con Actividad</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="total-sessions">0</div>
                <div class="stat-label">Sesiones Totales</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="current-month">0</div>
                <div class="stat-label">D√≠as Activos Este Mes</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="last-workout">-</div>
                <div class="stat-label">√öltimo Entrenamiento</div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        // Datos del servidor
        const heatmapData = /*[[${heatmapData}]]*/ {};

        // Funci√≥n para determinar el nivel de color basado en actividad
        function getColorLevel(count) {
            if (count === 0) return 0;
            if (count === 1) return 1;
            if (count === 2) return 2;
            if (count === 3) return 3;
            return 4;
        }

        // Generar el heatmap
        function generateHeatmap() {
            const heatmapContainer = document.getElementById('heatmap');
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 364); // 365 d√≠as incluyendo hoy

            let html = '<div class="heatmap-grid">';

            // Generar por semanas (52 columnas)
            for (let week = 0; week < 53; week++) {
                html += '<div class="heatmap-week">';

                // 7 d√≠as por semana
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7) + day);

                    if (currentDate <= today) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        const count = heatmapData[dateStr] || 0;
                        const level = getColorLevel(count);
                        const dayName = currentDate.toLocaleDateString('es-ES', { weekday: 'short' });
                        const dateFormatted = currentDate.toLocaleDateString('es-ES');

                        html += `<div class="heatmap-day"
                                     data-level="${level}"
                                     data-count="${count}"
                                     data-date="${dateStr}"
                                     title="${dateFormatted} - ${count} ${count === 1 ? 'sesi√≥n' : 'sesiones'}">
                                </div>`;
                    } else {
                        html += '<div class="heatmap-day empty"></div>';
                    }
                }

                html += '</div>';
            }

            html += '</div>';
            heatmapContainer.innerHTML = html;
        }

        // Calcular estad√≠sticas
        function calculateStats() {
            const dates = Object.keys(heatmapData);
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();

            let totalDays = 0;
            let totalSessions = 0;
            let daysThisMonth = 0;
            let lastWorkoutDate = null;

            dates.forEach(dateStr => {
                const count = heatmapData[dateStr];
                if (count > 0) {
                    totalDays++;
                    totalSessions += count;

                    const date = new Date(dateStr);
                    if (date.getMonth() === thisMonth && date.getFullYear() === thisYear) {
                        daysThisMonth++;
                    }

                    if (!lastWorkoutDate || date > lastWorkoutDate) {
                        lastWorkoutDate = date;
                    }
                }
            });

            document.getElementById('total-days').textContent = totalDays;
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('current-month').textContent = daysThisMonth;

            if (lastWorkoutDate) {
                const daysSince = Math.floor((today - lastWorkoutDate) / (1000 * 60 * 60 * 24));
                if (daysSince === 0) {
                    document.getElementById('last-workout').textContent = 'Hoy';
                } else if (daysSince === 1) {
                    document.getElementById('last-workout').textContent = 'Ayer';
                } else {
                    document.getElementById('last-workout').textContent = `Hace ${daysSince} d√≠as`;
                }
            } else {
                document.getElementById('last-workout').textContent = 'Sin datos';
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            generateHeatmap();
            calculateStats();
        });
    </script>

    <style>
        .report-header {
            margin-bottom: 30px;
        }

        .report-header h1 {
            margin-bottom: 10px;
        }

        .report-header p {
            color: #666;
            margin-bottom: 20px;
        }

        .heatmap-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .heatmap-description {
            color: #666;
            margin-bottom: 20px;
        }

        #heatmap {
            overflow-x: auto;
            margin: 20px 0;
        }

        .heatmap-grid {
            display: flex;
            gap: 3px;
            min-width: fit-content;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background-color: #ebedf0;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .heatmap-day:hover {
            transform: scale(1.5);
            z-index: 10;
            position: relative;
        }

        .heatmap-day.empty {
            background-color: transparent;
        }

        .heatmap-day[data-level="0"] {
            background-color: #ebedf0;
        }

        .heatmap-day[data-level="1"] {
            background-color: #9be9a8;
        }

        .heatmap-day[data-level="2"] {
            background-color: #40c463;
        }

        .heatmap-day[data-level="3"] {
            background-color: #30a14e;
        }

        .heatmap-day[data-level="4"] {
            background-color: #216e39;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-box[data-level="0"] { background-color: #ebedf0; }
        .legend-box[data-level="1"] { background-color: #9be9a8; }
        .legend-box[data-level="2"] { background-color: #40c463; }
        .legend-box[data-level="3"] { background-color: #30a14e; }
        .legend-box[data-level="4"] { background-color: #216e39; }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.95em;
        }
    </style>
</body>
</html>
